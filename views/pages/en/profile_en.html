{{ define "content" }}
<nav class="vertical-nav">
    <a href="/?lang={{ .lang }}" class="vertical-nav-brand">BiomassX</a>
    <div class="vertical-nav-menu">
        <a href="/dashboard?lang={{ .lang }}" class="nav-item">Dashboard</a>
        <span class="nav-category">Order</span>
        <a href="/order?lang={{ .lang }}" class="nav-item">products</a>
        <a class="nav-subcategory">services</a>
        <a class="nav-subcategory">assets</a>
        
        <span class="nav-category">History</span>
        <a href="/contract?lang={{ .lang }}" class="nav-item">products</a>
        <a class="nav-subcategory">services</a>
        <a class="nav-subcategory">assets</a>
        
        <span class="nav-category">Setting</span>
        <a href = "/profile?lang={{ .lang }}" class="nav-subcategory">profile</a>
        <a href="/logout?lang={{ .lang }}" hx-post="/logout?lang={{ .lang }}" hx-redirect="/login?lang={{ .lang }}" class="nav-item">Logout</a>
    </div>
</nav>

<main class="main-dashboard main-with-vertical-nav">
  <div id="response"></div>
<div class="profile-container">
    <h2>Profile Information</h2>
    
    <!-- User Information -->
    <div class="user-info">
        <p><strong>Name:</strong> 
            <span id="first_name">{{if .user.FirstName.Valid}}{{.user.FirstName.String}}{{end}}</span> 
            <span id="last_name">{{if .user.LastName.Valid}}{{.user.LastName.String}}{{end}}</span>
        </p>
        <p><strong>Email:</strong> <span id="email">{{if .user.Email.Valid}}{{.user.Email.String}}{{end}}</span></p>
        <p><strong>Phone:</strong> <span id="phone">{{if .user.Phone.Valid}}{{.user.Phone.String}}{{end}}</span></p>
        <button class="edit-btn" onclick="toggleEdit('user')">Edit</button>
    </div>
    
    <!-- Displaying Addresses -->
    {{if .user.Addresses}}
    <h2>Addresses</h2>
    <div class="address-table-container">
        <table class="address-table">
            <thead>
                <tr>
                    <th>Address Type</th>
                    <th>Branch number</th>
                    <th>Tax ID</th>
                    <th>Address</th>
                    <th>Street</th>
                    <th>Subdistrict/Town</th>
                    <th>District/City</th>
                    <th>Province/State</th>
                    <th>Country</th>
                    <th>Postal Code</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{range $index, $address := .user.Addresses}}
                <tr data-address-id="{{$address.ID.Int64}}">
                    <td>{{if $address.AddressType.EnName.Valid}}{{$address.AddressType.EnName.String}}{{end}}</td>
                    <td>{{if $address.BranchNumber.Valid}}{{$address.BranchNumber.String}}{{end}}</td>
                    <td>{{if $address.Taxnumber.Valid}}{{$address.Taxnumber.String}}{{end}}</td>
                    <td>{{if $address.Address.Valid}}{{$address.Address.String}}{{end}}</td>
                    <td>{{if $address.Street.Valid}}{{$address.Street.String}}{{end}}</td>
                    <td>{{if $address.Subdistrict.EnName.Valid}}{{$address.Subdistrict.EnName.String}}{{end}}</td>
                    <td>{{if $address.District.EnName.Valid}}{{$address.District.EnName.String}}{{end}}</td>
                    <td>{{if $address.Province.EnName.Valid}}{{$address.Province.EnName.String}}{{end}}</td>
                    <td>{{if $address.Country.EnName.Valid}}{{$address.Country.EnName.String}}{{end}}</td>
                    <td>{{if $address.PostalCode.Valid}}{{$address.PostalCode.String}}{{end}}</td>
                    <td>
                        <button class="edit-btn" onclick="toggleEdit('address-{{$index}}')">Edit</button>
                        <button class="delete-btn" onclick="deleteAddress('{{$address.ID.Int64}}')">Delete</button>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>
    {{else}}
    <h3>No addresses available.</h3>
    {{end}}

    <!-- Add Address Button -->
    <button class="add-address-btn" onclick="toggleEdit('add-address')">Add Address</button>

</div>

<div id="user-edit-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('user-edit-modal')">&times;</span>
      <h2>Edit Profile</h2>
      <form id="profile-form">
        <div class="form-group">
          <label for="first_name">First name:</label>
          <input type="text" id="edit_first_name" name="firstName" value="{{if .user.FirstName.Valid}}{{.user.FirstName.String}}{{end}}">
        </div>
        <div class="form-group">
          <label for="last_name">Last name:</label>
          <input type="text" id="edit_last_name" name="lastName" value="{{if .user.LastName.Valid}}{{.user.LastName.String}}{{end}}">
        </div>
        <div class="form-group">
          <label for="organization_name">Organization name</label>
          <input type="text" id="edit_organization_name" name="organizationName" value="{{if .user.Organization.Valid}}{{.user.Organization.String}}{{end}}">
        </div>
        <div class="form-group">
          <label for="username">User name:</label>
          <input type="text" id="edit_username" name="username" value="{{if .user.Username.Valid}}{{.user.Username.String}}{{end}}">
        </div>
        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="edit_email" name="email" value="{{if .user.Email.Valid}}{{.user.Email.String}}{{end}}">
        </div>
        <div class="form-group">
          <label for="phone">Phone:</label>
          <input type="text" id="edit_phone" name="phone" value="{{if .user.Phone.Valid}}{{.user.Phone.String}}{{end}}">
        </div>
        <div class="form-group">
          <label for="password">New password:</label>
          <input type="password" id="edit_password" name="password">
          <small>Leave blank if you don't want to change password</small>
        </div>
        <div class="form-group">
          <label for="confirm_password">Confirm New Password:</label>
          <input type="password" id="edit_confirm_password" name="confirmPassword">
        </div>
        <div class="button-group">
          <button type="button" onclick="saveUserProfile()">Save</button>
          <button type="button" onclick="closeModal('user-edit-modal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="add-address-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('add-address-modal')">&times;</span>
      <h2>Add addresses</h2>
      <form id="add-address-form">
        <div class="form-group">
          <label for="address_type_id">Addresses type:</label>
          <select id="address_type_id" name="address_type_id" required>
            <option value="">--Select Addresses Type --</option>
            <!-- Will be populated via JavaScript -->
          </select>
        </div>
        <div class="form-group">
          <label for="branch_number">Branch:</label>
          <input type="text" id="branch_number" name="branch_number" maxlength="5">
        </div>
        
        <div class="form-group">
          <label for="tax_number">Tax ID:</label>
          <input type="text" id="tax_number" name="tax_number" maxlength="13">
        </div>
        
        <div class="form-group">
          <label for="country_id">Country:</label>
          <select id="country_id" name="country_id" required>
            <option value="">-- Select Country --</option>
            <!-- Will be populated via JavaScript -->
          </select>
        </div>
        <div class="form-group">
          <label for="province_id">Province:</label>
          <select id="province_id" name="province_id" required>
            <option value="">--Select Province --</option>
            <!-- Will be populated via JavaScript -->
          </select>
        </div>
        <div class="form-group">
          <label for="district_id">District:</label>
          <select id="district_id" name="district_id" required>
            <option value="">-- Select District --</option>
            <!-- Will be populated via JavaScript -->
          </select>
        </div>
        <div class="form-group">
          <label for="subdistrict_id">Subdistrict:</label>
          <select id="subdistrict_id" name="subdistrict_id" required>
            <option value="">-- Select Subdistrict --</option>
            <!-- Will be populated via JavaScript -->
          </select>
        </div>
        <div class="form-group">
          <label for="street">Street:</label>
          <input type="text" id="street" name="street">
        </div>
        <div class="form-group">
          <label for="address">Address:</label>
          <textarea id="address" name="address" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label for="postal_code">Postal code:</label>
          <input type="text" id="postal_code" name="postal_code" maxlength="5" required>
        </div>
        <div class="button-group">
          <button type="button" onclick="saveAddress()">save</button>
          <button type="button" onclick="closeModal('add-address-modal')">cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="edit-address-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('edit-address-modal')">&times;</span>
      <h2>Edit address</h2>
      <form id="edit-address-form">
        <input type="hidden" id="edit_address_id" name="address_id">
        <div class="form-group">
          <label for="edit_address_type_id">Addresses Type:</label>
          <select id="edit_address_type_id" name="address_type_id" required>
            <option value="">-- Select Address Type --</option>
            <!-- Will be populated via JavaScript -->
          </select>
        </div>
        <div class="form-group">
          <label for="edit_branch_number">Branch:</label>
          <input type="text" id="edit_branch_number" name="branch_number" maxlength="5">
        </div>

        <div class="form-group">
          <label for="edit_taxnumber">Tax ID:</label>
          <input type="text" id="edit_taxnumber" name="tax_number" maxlength="13">
        </div>

        <div class="form-group">
          <label for="edit_country_id">Country:</label>
          <select id="edit_country_id" name="country_id" required>
            <option value="">-- Select  Country --</option>
            <!-- Will be populated via JavaScript -->
          </select>
        </div>
        <div class="form-group">
          <label for="edit_province_id">Province:</label>
          <select id="edit_province_id" name="province_id" required>
            <option value="">-- Select Province --</option>
            <!-- Will be populated via JavaScript -->
          </select>
        </div>
        <div class="form-group">
          <label for="edit_district_id">District:</label>
          <select id="edit_district_id" name="district_id" required>
            <option value="">-- Select District --</option>
            <!-- Will be populated via JavaScript -->
          </select>
        </div>
        <div class="form-group">
          <label for="edit_subdistrict_id">Subdistrict:</label>
          <select id="edit_subdistrict_id" name="subdistrict_id" required>
            <option value="">-- Select Subdistrict --</option>
            <!-- Will be populated via JavaScript -->
          </select>
        </div>
        <div class="form-group">
          <label for="edit_street">Street:</label>
          <input type="text" id="edit_street" name="street">
        </div>
        <div class="form-group">
          <label for="edit_address">Address:</label>
          <textarea id="edit_address" name="address" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label for="edit_postal_code">Postal code:</label>
          <input type="text" id="edit_postal_code" name="postal_code" maxlength="5" required>
        </div>
        <div class="button-group">
          <button type="button" onclick="updateAddress()">save</button>
          <button type="button" onclick="closeModal('edit-address-modal')">cancel</button>
        </div>
      </form>
    </div>
  </div>
</main>



<script>
window.toggleEdit = function(formType) {
    if (formType === 'user') {
      document.getElementById('user-edit-modal').style.display = 'block';
    } else if (formType === 'add-address') {
      document.getElementById('add-address-modal').style.display = 'block';
      // Load initial form data
      loadAddressTypes();
      loadCountries();
    } else if (formType.startsWith('address-')) {
      // Extract index from the formType
      const index = formType.split('-')[1];
      // Get the address ID from the row
      const addressRow = document.querySelectorAll('.address-table tbody tr')[parseInt(index)];
      const addressId = addressRow.getAttribute('data-address-id');
      
      // Open edit modal and load address data
      document.getElementById('edit-address-modal').style.display = 'block';
      loadAddressForEditing(addressId);
    }
};
// Function to close the modal
window.closeModal = function(modalId) {
  document.getElementById(modalId).style.display = 'none';
};    


// Add delete address function
window.deleteAddress = function(addressId) {
        if (!confirm("Are you sure you want to delete this address?")) {
            return; // User canceled the operation
        }
        
        // Create request data
        const requestData = {
            addressId: parseInt(addressId)
        };
        
        // Send request to server
        fetch('/api/delete-address', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
            credentials: 'same-origin' // Include cookies for authentication
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Server responded with status: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Show success message
                const responseDiv = document.getElementById('response');
                responseDiv.className = 'success-message';
                responseDiv.textContent = 'Address has been deleted successfully';
                
                // Remove the row from the table
                const addressRow = document.querySelector(`tr[data-address-id="${addressId}"]`);
                if (addressRow) {
                    addressRow.remove();
                } else {
                    // If we can't find the specific row, reload the page
                    window.location.reload();
                }
                
                // Clear message after 3 seconds
                setTimeout(() => {
                    responseDiv.textContent = '';
                    responseDiv.className = '';
                }, 3000);
            } else {
                throw new Error('Failed to delete address');
            }
        })
        .catch(error => {
            console.error('Error deleting address:', error);
            const responseDiv = document.getElementById('response');
            responseDiv.className = 'error-message';
            responseDiv.textContent = 'Error deleting address: ' + error.message;
        });
    };

    

function validateForm() {
  const password = document.getElementById('edit_password').value;
  const confirmPassword = document.getElementById('edit_confirm_password').value;
  
  // If password field is not empty, check if it matches confirm password
  if (password && password !== confirmPassword) {
    showMessage('Passwords do not match. Please check again.', 'error-message');
    return false;
  }
  
  return true;
}

// Function to save user profile
window.saveUserProfile = function() {
  // Validate form first
  if (!validateForm()) {
    return;
  }
  
  // Collect form data
  const userData = {
    firstName: document.getElementById('edit_first_name').value,
    lastName: document.getElementById('edit_last_name').value,
    organizationName: document.getElementById('edit_organization_name').value,
    username: document.getElementById('edit_username').value,
    email: document.getElementById('edit_email').value,
    phone: document.getElementById('edit_phone').value,
    password: document.getElementById('edit_password').value
  };
  
  // Remove empty fields so they won't be updated
  Object.keys(userData).forEach(key => {
    if (!userData[key]) {
      delete userData[key];
    }
  });
  
  // Send request to server
  fetch('/api/update-profile', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(userData),
    credentials: 'same-origin' // Include cookies for authentication
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Server responded with status: ' + response.status);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      // Show success message
      showMessage('Profile information has been saved successfully', 'success-message');
      
      // Update displayed user info
      if (userData.firstName) document.getElementById('first_name').textContent = userData.firstName;
      if (userData.lastName) document.getElementById('last_name').textContent = userData.lastName;
      if (userData.email) document.getElementById('email').textContent = userData.email;
      if (userData.phone) document.getElementById('phone').textContent = userData.phone;
      
      // Close the modal
      closeModal('user-edit-modal');
    } else {
      throw new Error(data.message || 'Failed to update profile');
    }
  })
  .catch(error => {
    console.error('Error updating profile:', error);
    showMessage('rror saving information: ' + error.message, 'error-message');
  });
};

// Functions to load initial data for address form

// 1. Load address types
function loadAddressTypes() {
  const select = document.getElementById('address_type_id');
  select.innerHTML = '<option value="">-- Select Address Type --</option>';
  select.disabled = true;
  
  fetch('/api/address-types')
    .then(response => {
      if (!response.ok) {
        throw new Error('Error fetching address types');
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.addressTypes) {
        data.addressTypes.forEach(type => {
          const option = document.createElement('option');
          option.value = type.id;
          option.textContent = `${type.enName}`;
          select.appendChild(option);
        });
        select.disabled = false;
      }
    })
    .catch(error => {
      console.error('Failed to load address types:', error);
      showMessage('Unable to load address types', 'error-message');
    });
}

// 2. Load countries
function loadCountries() {
  const select = document.getElementById('country_id');
  select.innerHTML = '<option value="">-- Select Country --</option>';
  select.disabled = true;
  
  fetch('/api/countries')
    .then(response => {
      if (!response.ok) {
        throw new Error('Error fetching countries');
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.countries) {
        data.countries.forEach(country => {
          const option = document.createElement('option');
          option.value = country.id;
          option.textContent = `${country.enName}`;
          select.appendChild(option);
        });
        select.disabled = false;
      }
    })
    .catch(error => {
      console.error('Failed to load countries:', error);
      showMessage('Unable to load countries', 'error-message');
    });
}

// 3. Load provinces based on country selection
function loadProvinces(countryId) {
  const provinceSelect = document.getElementById('province_id');
  const districtSelect = document.getElementById('district_id');
  const subdistrictSelect = document.getElementById('subdistrict_id');
  
  // Reset child dropdowns
  provinceSelect.innerHTML = '<option value="">-- Select Province --</option>';
  districtSelect.innerHTML = '<option value="">-- Select District --</option>';
  subdistrictSelect.innerHTML = '<option value="">-- Select Subdistrict --</option>';
  
  provinceSelect.disabled = true;
  districtSelect.disabled = true;
  subdistrictSelect.disabled = true;
  
  if (!countryId) {
    return;
  }
  
  fetch(`/api/provinces?countryId=${countryId}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Error fetching provinces');
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.provinces) {
        data.provinces.forEach(province => {
          const option = document.createElement('option');
          option.value = province.id;
          option.textContent = `${province.enName}`;
          provinceSelect.appendChild(option);
        });
        provinceSelect.disabled = false;
      }
    })
    .catch(error => {
      console.error('Failed to load provinces:', error);
      showMessage('Unable to load provinces', 'error-message');
    });
}

// 4. Load districts based on province selection
function loadDistricts(provinceId) {
  const districtSelect = document.getElementById('district_id');
  const subdistrictSelect = document.getElementById('subdistrict_id');
  
  // Reset child dropdowns
  districtSelect.innerHTML = '<option value="">-- Select District --</option>';
  subdistrictSelect.innerHTML = '<option value="">-- Select Subdistrict --</option>';
  
  districtSelect.disabled = true;
  subdistrictSelect.disabled = true;
  
  if (!provinceId) {
    return;
  }
  
  fetch(`/api/districts?provinceId=${provinceId}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Error fetching districts');
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.districts) {
        data.districts.forEach(district => {
          const option = document.createElement('option');
          option.value = district.id;
          option.textContent = `${district.enName}`;
          districtSelect.appendChild(option);
        });
        districtSelect.disabled = false;
      }
    })
    .catch(error => {
      console.error('Failed to load districts:', error);
      showMessage('Unable to load districts', 'error-message');
    });
}

// 5. Load subdistricts based on district selection
function loadSubdistricts(districtId) {
  const subdistrictSelect = document.getElementById('subdistrict_id');
  
  // Reset dropdown
  subdistrictSelect.innerHTML = '<option value="">-- Select Subdistrict --</option>';
  subdistrictSelect.disabled = true;
  
  if (!districtId) {
    return;
  }
  
  fetch(`/api/subdistricts?districtId=${districtId}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Error fetching subdistricts');
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.subdistricts) {
        data.subdistricts.forEach(subdistrict => {
          const option = document.createElement('option');
          option.value = subdistrict.id;
          option.textContent = `${subdistrict.enName}`;
          subdistrictSelect.appendChild(option);
        });
        subdistrictSelect.disabled = false;
      }
    })
    .catch(error => {
      console.error('Failed to load subdistricts:', error);
      showMessage('Unable to load subdistricts', 'error-message');
    });
}

// 6. Save address function
function saveAddress() {
  // Get form values
  const form = document.getElementById('add-address-form');
  const addressTypeId = parseInt(document.getElementById('address_type_id').value);
  const branchNumber = document.getElementById('branch_number').value.trim();
  const tax_number = document.getElementById('tax_number').value.trim(); 
  const countryId = parseInt(document.getElementById('country_id').value);
  const provinceId = parseInt(document.getElementById('province_id').value);
  const districtId = parseInt(document.getElementById('district_id').value);
  const subdistrictId = parseInt(document.getElementById('subdistrict_id').value);
  const street = document.getElementById('street').value.trim();
  const address = document.getElementById('address').value.trim();
  const postalCode = document.getElementById('postal_code').value.trim();
  
  // Validate required fields
  if (!addressTypeId || !countryId || !address || !postalCode) {
    showMessage('Please fill out all required fields', 'error-message');
    return;
  }
  
  // Create request data
  const addressData = {
    address_type_id: addressTypeId,
    branch_number: branchNumber,
    tax_number: tax_number,
    country_id: countryId,
    province_id: provinceId,
    district_id: districtId,
    subdistrict_id: subdistrictId,
    street: street,
    address: address,
    postal_code: postalCode
  };
  
  // Send request to server
  fetch('/api/add-address', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(addressData),
    credentials: 'same-origin' // Include cookies for authentication
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Server responded with status: ' + response.status);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      // Show success message
      showMessage('Address added successfully', 'success-message');
      
      // Close the modal
      closeModal('add-address-modal');
      
      // Reload the page to show new address
      setTimeout(() => {
        window.location.reload();
      }, 1500);
    } else {
      throw new Error(data.message || 'Failed to add address');
    }
  })
  .catch(error => {
    console.error('Error adding address:', error);
    showMessage('Error adding address: ' + error.message, 'error-message');
  });
}

// Event listeners for cascading dropdowns
document.addEventListener('DOMContentLoaded', function() {
  // Setup country change event to load provinces
  const countrySelect = document.getElementById('country_id');
  if (countrySelect) {
    countrySelect.addEventListener('change', function() {
      loadProvinces(this.value);
    });
  }
  
  // Setup province change event to load districts
  const provinceSelect = document.getElementById('province_id');
  if (provinceSelect) {
    provinceSelect.addEventListener('change', function() {
      loadDistricts(this.value);
    });
  }
  
  // Setup district change event to load subdistricts
  const districtSelect = document.getElementById('district_id');
  if (districtSelect) {
    districtSelect.addEventListener('change', function() {
      loadSubdistricts(this.value);
    });
  }
});

function loadAddressForEditing(addressId) {
  // Set the address ID in the hidden field
  document.getElementById('edit_address_id').value = addressId;
  
  // Display loading message
  showMessage('Loading address data...', 'info-message');
  
  // First load all the selection options
  loadAddressTypesForEdit();
  loadCountriesForEdit();
  
  // Then fetch the address data and set the selected values
  // CHANGE THIS LINE - use the correct API endpoint
  fetch(`/api/address?id=${addressId}`)  // Modified endpoint
    .then(response => {
      if (!response.ok) {
        console.error('Server error:', response.status, response.statusText);
        throw new Error(`Server responded with status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.address) {

        const address = data.address;
        
        // Set the selected values in the dropdowns with better error handling
        document.getElementById('edit_address_type_id').value = address.address_type_id;
        document.getElementById('edit_country_id').value = address.country_id;
        
        // Add error handling for each cascading dropdown
        loadProvincesForEdit(address.country_id)
          .then(() => {
            document.getElementById('edit_province_id').value = address.province_id;
            return loadDistrictsForEdit(address.province_id);
          })
          .then(() => {
            document.getElementById('edit_district_id').value = address.district_id;
            return loadSubdistrictsForEdit(address.district_id);
          })
          .then(() => {
            document.getElementById('edit_subdistrict_id').value = address.subdistrict_id;
            
            // Set other form fields
            document.getElementById('edit_branch_number').value = address.branch_number || '';
            document.getElementById('edit_taxnumber').value = address.tax_number || '';
            document.getElementById('edit_street').value = address.street || '';
            document.getElementById('edit_address').value = address.address || '';
            document.getElementById('edit_postal_code').value = address.postal_code || '';
            
            // Clear loading message
            document.getElementById('response').textContent = '';
            document.getElementById('response').className = '';
          })
          .catch(error => {
            console.error('Error setting form values:', error);
            showMessage('Error setting form values: ' + error.message, 'error-message');
          });
      } else {
        throw new Error(data.message || 'Failed to load address data');
    }
    })
    .catch(error => {
      console.error('Error loading address data:', error);
    });
}

// Simplified function to load address types for edit form
function loadAddressTypesForEdit() {
  const select = document.getElementById('edit_address_type_id');
  select.innerHTML = '<option value="">--Select Address Type --</option>';
  select.disabled = true;
  
  fetch('/api/address-types')
    .then(response => {
      if (!response.ok) {
        throw new Error('Error fetching address types');
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.addressTypes) {
        data.addressTypes.forEach(type => {
          const option = document.createElement('option');
          option.value = type.id;
          option.textContent = `${type.enName}`;
          select.appendChild(option);
        });
        select.disabled = false;
      }
    })
    .catch(error => {
      console.error('Failed to load address types:', error);
    });
}

// Simplified function to load countries for edit form
function loadCountriesForEdit() {
  const select = document.getElementById('edit_country_id');
  select.innerHTML = '<option value="">-- Select Country --</option>';
  select.disabled = true;
  
  fetch('/api/countries')
    .then(response => {
      if (!response.ok) {
        throw new Error('Error fetching countries');
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.countries) {
        data.countries.forEach(country => {
          const option = document.createElement('option');
          option.value = country.id;
          option.textContent = `${country.enName}`;
          select.appendChild(option);
        });
        select.disabled = false;
      }
    })
    .catch(error => {
      console.error('Failed to load countries:', error);
    });
}

// Reuse the same provinces loading function but for edit form
function loadProvincesForEdit(countryId) {
  const provinceSelect = document.getElementById('edit_province_id');
  const districtSelect = document.getElementById('edit_district_id');
  const subdistrictSelect = document.getElementById('edit_subdistrict_id');
  
  // Reset child dropdowns
  provinceSelect.innerHTML = '<option value="">-- Select Province --</option>';
  districtSelect.innerHTML = '<option value="">-- Select District --</option>';
  subdistrictSelect.innerHTML = '<option value="">-- Select Subdistrict --</option>';
  
  provinceSelect.disabled = true;
  districtSelect.disabled = true;
  subdistrictSelect.disabled = true;
  
  if (!countryId) {
    return;
  }
  
  fetch(`/api/provinces?countryId=${countryId}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Error fetching provinces');
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.provinces) {
        data.provinces.forEach(province => {
          const option = document.createElement('option');
          option.value = province.id;
          option.textContent = `${province.enName}`;
          provinceSelect.appendChild(option);
        });
        provinceSelect.disabled = false;
      }
    })
    .catch(error => {
      console.error('Failed to load provinces:', error);
    });
}

// Reuse the same districts loading function but for edit form
function loadDistrictsForEdit(provinceId) {
  const districtSelect = document.getElementById('edit_district_id');
  const subdistrictSelect = document.getElementById('edit_subdistrict_id');
  
  // Reset child dropdowns
  districtSelect.innerHTML = '<option value="">-- Select District --</option>';
  subdistrictSelect.innerHTML = '<option value="">-- Select Subdistrict --</option>';
  
  districtSelect.disabled = true;
  subdistrictSelect.disabled = true;
  
  if (!provinceId) {
    return;
  }
  
  fetch(`/api/districts?provinceId=${provinceId}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Error fetching districts');
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.districts) {
        data.districts.forEach(district => {
          const option = document.createElement('option');
          option.value = district.id;
          option.textContent = `${district.enName}`;
          districtSelect.appendChild(option);
        });
        districtSelect.disabled = false;
      }
    })
    .catch(error => {
      console.error('Failed to load districts:', error);
    });
}

// Reuse the same subdistricts loading function but for edit form
function loadSubdistrictsForEdit(districtId) {
  const subdistrictSelect = document.getElementById('edit_subdistrict_id');
  
  // Reset dropdown
  subdistrictSelect.innerHTML = '<option value="">-- Select District --</option>';
  subdistrictSelect.disabled = true;
  
  if (!districtId) {
    return;
  }
  
  fetch(`/api/subdistricts?districtId=${districtId}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Error fetching subdistricts');
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.subdistricts) {
        data.subdistricts.forEach(subdistrict => {
          const option = document.createElement('option');
          option.value = subdistrict.id;
          option.textContent = `${subdistrict.enName}`;
          subdistrictSelect.appendChild(option);
        });
        subdistrictSelect.disabled = false;
      }
    })
    .catch(error => {
      console.error('Failed to load subdistricts:', error);
    });
}

// Function to update address
function updateAddress() {
  // Get form values
  const addressId = parseInt(document.getElementById('edit_address_id').value);
  const addressTypeId = parseInt(document.getElementById('edit_address_type_id').value) || null;
  const branchNumber = document.getElementById('edit_branch_number').value.trim();
  const tax_number = document.getElementById('edit_taxnumber').value.trim();
  const countryId = parseInt(document.getElementById('edit_country_id').value) || null;
  const provinceId = parseInt(document.getElementById('edit_province_id').value) || null;
  const districtId = parseInt(document.getElementById('edit_district_id').value) || null;
  const subdistrictId = parseInt(document.getElementById('edit_subdistrict_id').value) || null;
  const street = document.getElementById('edit_street').value.trim();
  const address = document.getElementById('edit_address').value.trim();
  const postalCode = document.getElementById('edit_postal_code').value.trim();
  
  // Create request data (only include fields with values)
  const addressData = { address_id: addressId };
  
  // Only add fields with values to the request
  if (addressTypeId) addressData.address_type_id = addressTypeId;
  if (branchNumber) addressData.branch_number = branchNumber;
  if (tax_number) addressData.tax_number = tax_number;
  if (countryId) addressData.country_id = countryId;
  if (provinceId) addressData.province_id = provinceId;
  if (districtId) addressData.district_id = districtId;
  if (subdistrictId) addressData.subdistrict_id = subdistrictId;
  if (street) addressData.street = street;
  if (address) addressData.address = address;
  if (postalCode) addressData.postal_code = postalCode;
  
  // Log the request for debugging
  console.log('Sending request to update address:', addressData);
  
  // Get the correct API URL - adjust this based on your actual API endpoint
  const apiUrl = window.location.origin + '/api/update-address';
  
  // Send request to server
  fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'  // Add this for some server configurations
    },
    body: JSON.stringify(addressData),
    credentials: 'same-origin' // Include cookies for authentication
  })
  .then(response => {
    console.log('Server response status:', response.status);
    if (!response.ok) {
      return response.text().then(text => {
        throw new Error(`Server responded with status: ${response.status}. Response: ${text}`);
      });
    }
    return response.json();
  })
  .then(data => {
    console.log('Server response data:', data);
    if (data.success) {
      // Show success message
      showMessage('Address updated successfully', 'success-message');
      
      // Close the modal
      closeModal('edit-address-modal');
      
      // Reload the page to show updated address
      setTimeout(() => {
        window.location.reload();
      }, 1500);
    } else {
      throw new Error(data.message || 'Failed to update address');
    }
  })
  .catch(error => {
    console.error('Error updating address:', error);
    showMessage('Error updating address: ' + error.message, 'error-message');
  });
}
document.addEventListener('DOMContentLoaded', function() {
  // Setup event listeners for edit form dropdowns
  const editCountrySelect = document.getElementById('edit_country_id');
  if (editCountrySelect) {
    editCountrySelect.addEventListener('change', function() {
      loadProvincesForEdit(this.value);
    });
  }
  
  const editProvinceSelect = document.getElementById('edit_province_id');
  if (editProvinceSelect) {
    editProvinceSelect.addEventListener('change', function() {
      loadDistrictsForEdit(this.value);
    });
  }
  
  const editDistrictSelect = document.getElementById('edit_district_id');
  if (editDistrictSelect) {
    editDistrictSelect.addEventListener('change', function() {
      loadSubdistrictsForEdit(this.value);
    });
  }
});

function showMessage(message, className) {
  const responseDiv = document.getElementById('response');
  responseDiv.className = className;
  responseDiv.textContent = message;
  
  // Scroll to the top of the page to ensure the message is visible
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Clear message after 3 seconds
  setTimeout(() => {
    responseDiv.textContent = '';
    responseDiv.className = '';
  }, 3000);
}

</script>
<div style="margin-bottom: 200px;"></div>
<footer class="footer-with-vertical-nav">
  <br>
  <a href="/about?lang={{ .lang }}">About us</a> | <a href="/faqs?lang={{ .lang }}">FAQs</a> | <a href="/contact?lang={{ .lang }}">Contact us</a><br>
  <p>BIOMASS EXCHANGE CO., LTD.</p>
  <br>
</footer>
{{ end }}